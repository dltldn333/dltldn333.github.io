---
title: "[CSAPP] malloc lab(1) 메모리 할당기를 구현해보자"
date: 2025-04-24 02:35:00 +0900
tags: [C언어, CSAPP, malloc]
categories: [CSAPP]
image:
  path: /assets/img/posts/mallocLab/mallocThumb.jpg
  alt: [malloc 썸네일 이미지]
excerpt: ""
pin: true
---

### "malloc은 단순히 메모리를 '할당'해주는 함수일 뿐일까?
  

**CSAPP**에서 제시한 **malloc 프로젝트**를 따라 직접 **동적 메모리 할당기**의 구조를 시뮬레이션해보며 **malloc**을 조금 더 깊게 이해 해볼 것이다.

이제부터 **malloc**, **free**, **realloc**기능을 구현하면서 **동적 메모리 할당기**가 어떻게 동작하는 지 알아보자.

먼저 **동적 메모리 할당기**가 수행하는 동작들에 대해서 알아보자.

# malloc, free, realloc

위의 세가지 동작들은 동적 메모리 할당기의 핵심적인 동작이며 동시에 우리가 지금부터 구현해야 할 함수들이다. 

아래에 각각의 함수들이 수행하는 동작을 간단하게 적어 놓았다.


#### malloc
malloc은 메모리를 할당해준다.

요청한 크기의 블록을 찾아서 반환한다. 없으면 새로운 heap공간을 확장한다.

#### free
free는 할당된 메모리를 해제하고 재사용할 수 있는 공간으로 만들어준다.

#### realloc

realloc은 메모리를 재할당해준다.

기존 블록을 새 크기로  변경한다. 필요하면 새로운 블록으로 복사한다.

---

<br>

다음으로 **동적 메모리 할당기**가 어떤 형태로 메모리를 저장하고 관리하는지 알아야 한다.

# 동적 메모리 할당기의 메모리 관리 방식

동적 메모리 할당기는 가상메모리의 heap영역에서 **블록단위**로 메모리를 관리한다.

#### 경계 태그

앞뒤 블록과의  병합을 쉽게 하기 위하여 블록 양쪽에 기록해 놓은 header/footer를 칭한다.


![블록](assets/img/posts/mallocLab/block.png)

위 그림은 하나의 단위의 블록의 구성요소이다.

#### header
블록의 맨 앞에 위치한다. footer와 달리 항상 존재한다.

**저장내용**
- 블록의 전체 크기
- 할당 여부(1 비트) -> 할당됨(1)/비어있음(0)

보통 4바이트 또는 8바이트의 크기를 가진다.
csapp에서 제시한 구현법이 32비트 시스템 기준이기에 우리는 header를 4바이트로 설정할 것이다.

우리는 더블워드(2*4bytes) 정렬을 사용하기에 블록의 크기는 항상 8의 배수를 가진다.

8을 바이너리로 변환하면 **1000**이다 8의 배수를 사용한다는 것은 어떠한 경우에도 바이너리 코드의 뒤 3자리는 000이 보장된다는 것이다. **하위 3비트는 항상 0**이라는 것이다. 이 덕에 그 공간에 할당 유무를 저장 할 수 있다. 하위 첫번째 비트에 **1(할당됨)/0(비어있음)**을 명시하는 것이다. 인간의 숫자로 표현하면 이렇다.
  
**"(8 * n + 1) == 8 * n 바이트 크기를 가진 블록으로 이루어진 할당된 공간" / "(8 * n + 0) == 8 * n 바이트 크기를 가진 블록으로 이루어진 할당되지 않은 공간"**


#### footer
헤더와 동일한 정보가 저장된다. 양방향 병합을 쉽게하기 위해서 존재하며 보통 free블록에서 사용된다.

#### payload

사용자가 직접 사용하는 메모리 영역이다.
malloc이 리턴하는 포인터는 payload 영역의 시작주소를 가르킨다.
정렬규칙을 따라야 한다. 우리는 더블워드 (8바이트) 정렬규칙을 따를것이다. 

---

<br>

다음으로 heap에서 malloc이 관리하는 전체 영역, 그러니까 블록들이 존재하는 영역을 어떻게 명시하는 지 알아보자.

# 프롤로그 블록과 에필로그 블록

  
#### 프롤로그 블록
  
![프롤로그](assets/img/posts/mallocLab/prologue.png)


프롤로그 블록은 힙의 맨 앞에 존재하는 작은 dummy 블록이다.
탐색 및 병합 중 경계 조건을 단순하게 만들어 준다. 탐색과 병합은 free 블록을 찾아서 하는 것이기 때문에 **"할당됨"**으로 표시 된 프롤로그 블록은 자신의 크기만큼 탐색 포인터를 넘겨버린다.

앞 **4bytes**의 공백은 **8bytes정렬**을 맞추기 위함이다. 시스템이 8bytes씩 읽어야 함에 

(**free 블록**이 **8+8n bytes**인 이유는 **헤더+푸터+8바이트 정렬*n**이기 때문이다)
  
#### 에필로그 블록
  
![프롤로그](assets/img/posts/mallocLab/epilogue.png)
  
- 힙의 맨 끝에 위치하는 0바이트짜리 항상 할당된 블록.
    - 헤더는 존재 (4바이트 or 8바이트)
- 블록 탐색 종료 시점, coalescing에 유용.
- 힙 확장 시 → 뒤로 밀려남.

# leggo